(function(f){var e=undefined;function b(g){return g instanceof jQuery?g:f(g);}function c(k,j){var h=k.length,g=0;while(g<h){if(k[g]===j){return g;}g++;}return -1;}function a(i,j,h){var k=i[0];j=j===e?0:j;h=h===e?i.val().length:h;if(k.setSelectionRange){k.setSelectionRange(j,h);if(/chrom(e|ium)/.test(navigator.userAgent.toLowerCase())){var g=jQuery.Event("keydown",{which:37});i.triggerHandler(g);}}else{if(k.createTextRange){range=k.createTextRange();range.collapse(true);range.moveEnd("character",h);range.moveStart("character",j);range.select();}}}var d=function(h,g){this.element=f(h);this.init(g);};d.defaults={params:{id:"wtt_id",text:"wtt_title",pid:"wtt_parent_id",left:"wtt_left",right:"wtt_right",level:"wtt_depth",leaf:"wtt_is_leaf",path:"wtt_path",expand:"wtt_expanded"},itemSize:32,dragSize:16,stepSize:25,buffSize:20,delay:25,buffer:10,markup:"<div></div>"};d.prototype={init:function(g){this.options=f.extend(true,{},d.defaults,g||{});this.data=[];this.indexes={};this.orphans=[];this.visible=[];this.moving={data:null,desc:[],orig:null};this.initComponent();this.initEvents();this.fireEvent("init");},initComponent:function(){var g=this.options,h=g.params;this.element.addClass("bigtree").attr("tabindex",1);this.editor=f('<div class="bt-editor"><input type="text"></div>');this.edtext=this.editor.children("input");this.grid=f('<div class="bt-grid">').appendTo(this.element);f.templates({btnode:{markup:g.markup,helpers:{last:function(i){return i?"bt-last":"";},elbow:function(k){var t=[],j=+k[h.level],o=+k[h.expand]==1,l=+k[h.leaf]==0,q=k.$parent,n=[];while(q){t[q[h.level]]=q.$last?0:1;q=q.$parent;}for(var m=0;m<=j;m++){var p="",r="";if(m==j){p="elbow-end";if(l){var s=o?"elbow-minus":"elbow-plus";r='<span class="elbow-expander '+s+'"></span>';}}else{p=t[m]==1?"elbow-line":"";}n.push({type:p,icon:r});}return n;}}}});this.element.sortable({items:".bt-node",handle:".bt-drag"});},initEvents:function(){var h=this.options,j=this.element.scrollTop(),i="",g=0;this.element.off("scroll.bt").on("scroll.bt",f.throttle(h.delay,f.proxy(function(){var l=this.element.scrollTop(),k=l>j?"down":"up";g=i!=k?0:(g+Math.abs(l-j));if(g==0||g>=(h.buffer*h.itemSize)){this.render();g=0;}j=l;i=k;},this)));this.element.off("click.bt.expander").on("click.bt.expander",".elbow-expander",f.proxy(function(m){m.stopPropagation();var k=f(m.currentTarget).closest(".bt-node"),l=this.data[this.indexes[k.attr("data-id")]];if(l){if(l[h.params.expand]=="1"){this.collapse(l);}else{this.expand(l);}}},this));this.element.off("keydown.bt").on("keydown.bt",f.proxy(this.navigate,this));this.element.off("sortstart.bt").on("sortstart.bt",f.proxy(function(l,k){this.moveStart(k.item);},this));this.element.off("sortstop.bt").on("sortstop.bt",f.proxy(function(l,k){this.moveStop(k.item,k.originalPosition.left,k.position.left);},this));this.element.off("click.bt.select").on("click.bt.select",f.proxy(function(k){this.deselectAll();},this));this.element.off("click.bt.startedit").on("click.bt.startedit",".bt-text",f.proxy(function(l){l.stopPropagation();var k=f(l.currentTarget).closest(".bt-node");this.startEdit(k);},this));this.edtext.off("click.bt").on("click.bt",function(k){k.preventDefault();k.stopPropagation();});this.edtext.off("keypress.bt").on("keypress.bt",f.proxy(function(k){if(k.keyCode==13){k.preventDefault();this.stopEdit(false);}},this));},hasScroll:function(){return this.element[0].scrollHeight>this.element.height();},load:function(k){var j=this.options.params,h=this.data.length,t,m,l;k=k||[];m=k.length;this.data.push.apply(this.data,k);for(l=m;l--;this.indexes[k[l][j.id]]=l+h){}for(l=0;l<m;l++){var s=this.data[l+h],g=s[j.id],r=s[j.path].split("/"),n,o,q;r.pop();n=r.pop();s.$parent=null;if(n){var p=this.data[this.indexes[n]];if(p){p.$child=p.$child||[];o=p.$child[p.$child.length-1];q=this.data[this.indexes[o]];if(q){q.$last=false;}s.$last=true;s.$hidden=p[j.expand]=="0"||p.$hidden;s.$parent=p;p.$child.push(g);}}else{o=this.orphans[this.orphans.length-1];q=this.data[this.indexes[o]];if(q){q.$last=false;}s.$last=true;s.$hidden=false;this.orphans.push(g);}}},reindex:function(){var h=this.options.params;this.indexes={};for(var g=this.data.length;g--;this.indexes[this.data[g][h.id]]=g){}},render:function(){var k=this.grid.scrollTop(),i=this.grid.position().top,n=this.options.buffer*this.options.itemSize,g=k-i-n;epix=g+this.element.height()+n*2,data=f.grep(this.data,function(o){return !o.$hidden;});g=g<0?0:g;var m=Math.floor(g/this.options.itemSize),l=Math.ceil(epix/this.options.itemSize),j=this.options.itemSize*m,h=this.options.itemSize*data.slice(l).length+3*this.options.itemSize;this.grid.css({paddingTop:j,paddingBottom:h});this.renderRange(data,m,l);},renderRange:function(j,l,g){var h=j.slice(l,g),k=this.options.params,i=this.movedNode();this.editor.detach();this.removableNodes().remove();if(i.length){h=f.grep(h,function(m){return m[k.id]!=i.attr("data-id");});}this.visible=h;this.grid.append(f.templates.btnode(h));this.element.focus();if(i.length){this.element.sortable("refresh");}else{this.decorate();}},decorate:function(){if(this.selected){var g=this.grid.find(".bt-node[data-id="+this.selected+"]");g.length&&this.select(g);}},lastData:function(){return this.data[this.data.length-1];},visibleData:function(){return this.visible;},index:function(h){var g=this.indexes[h[this.options.params.id]];return isNaN(g)?-1:g;},descendants:function(i){var g=[];function h(l){var n=(l.$child||[]).slice(0);while(n.length){var k=n.shift(),j=this.indexes[k],m=this.data[j];if(m){g.push(m);if(m.$child!==e){h.call(this,m);}}}}h.call(this,i);return g;},children:function(l){var n=l.$child||[],j=n.length,h=[];for(var k=0;k<j;k++){var g=this.indexes[n[k]],m=this.data[g];if(m){h.push(m);}}return h;},nearest:function(k,j){var i=this.options.params,n=k.$parent,o=k[i.id];if(n){var l=n.$child||[],p=c(l,o);return this.data[this.indexes[l[p+j]]]||null;}else{var m=this.indexes[o],g=+k[i.level],h;m=m+j;near=this.data[m];while(near&&(h=+near[i.level])>=g){if(h==g){break;}m=m+j;near=this.data[m];}return near||null;}},parent:function(g){return g.$parent;},prev:function(g){return this.nearest(g,-1);},next:function(g){return this.nearest(g,1);},movedNode:function(){return this.grid.children(".ui-sortable-helper");},visibleNodes:function(){return this.grid.children(".bt-node:not(.ui-sortable-placeholder)");},removableNodes:function(){return this.grid.children(".bt-node:not(.ui-sortable-helper,.ui-sortable-placeholder)");},selectedNode:function(){var g=f({});if(this.selected){g=this.grid.children(".bt-node[data-id="+this.selected+"]");}return g.length?g:null;},nodeKey:function(g){return b(g).attr("data-id");},nodeData:function(i){var h=this.nodeKey(i),g=this.indexes[h];return this.data[g];},nodeLevel:function(g){return +b(g).attr("data-level");},isParentNode:function(g){return +b(g).attr("data-leaf")==0;},isLeafNode:function(g){return +b(g).attr("data-leaf")==1;},cascade:function(g,h){},expand:function(g){var i=this.options.params,h=function(m){var l=this.children(m),j=l.length;for(var k=0;k<j;k++){l[k].$hidden=false;if(l[k].$child!==e&&l[k][i.expand]=="1"){h.call(this,l[k]);}}};g[i.expand]="1";h.call(this,g);this.fireEvent("expand",g);this.render();},collapse:function(h){var i=this.options.params,g=function(m){var l=this.children(m),j=l.length;for(var k=0;k<j;k++){l[k].$hidden=true;if(l[k].$child!==e&&l[k][i.expand]=="1"){g.call(this,l[k]);}}};h[i.expand]="0";g.call(this,h);this.fireEvent("collapse",h);this.render();},expandAll:function(){},collapseAll:function(){},toggle:function(h,g,j){var k=h.find(".elbow-expander");g=g===e?true:g;if(k.length){if(g){var i=k.hasClass("elbow-plus")?"elbow-minus":"elbow-plus";if(j!==e){i=j=="expand"?"elbow-minus":"elbow-plus";}k.removeClass("elbow-plus elbow-minus").addClass(i);}else{}}},select:function(g){this.selected=g.attr("data-id");g.addClass("bt-selected");},deselect:function(g){this.selected=null;g.removeClass("bt-selected");},deselectAll:function(){this.selected=null;this.grid.find(".bt-selected").removeClass("bt-selected");},startEdit:function(h){var i=this.data[this.indexes[h.attr("data-id")]],l=this.options.params,g=h.find(".bt-text"),k=i[l.text];this.stopEdit(true);this.select(h);this.editor.appendTo(g);this.edtext.val(k).focus();var j=f.debounce(1,function(){a(this.edtext,k.length);});j.call(this);},stopEdit:function(h){var k=this.options.params,g=this.editor.closest(".bt-node");if(g.length){var i=this.data[this.indexes[g.attr("data-id")]],j=this.edtext.val(),l=i[k.text];i[k.text]=j;h=h===e?true:h;if(h){this.deselect(g);this.editor.detach();g.find(".bt-text").html(j);}if(j!=l){this.fireEvent("edit",i,j);}}else{this.selected=null;this.grid.find(".bt-selected").removeClass("bt-selected");}},search:function(k){var g=this.options.params,m=new RegExp("("+k+")","igm"),q=this.data.length,h,n,o,j;for(j=0;j<q;j++){h=this.data[j];n=h.$orig;if(n!==e){h.$hidden=n.hidden;h[g.expand]=n.expand;h[g.text]=n.text;delete h.$orig;}if(k){o=h[g.text];h.$orig={hidden:h.$hidden,expand:h[g.expand],text:o};var p=m.exec(o);h.$hidden=true;if(p){h.$hidden=false;h[g.text]=h[g.text].replace(p[1],'<span class="bt-text-hightlight">'+p[1]+"</span>");var l=h.$parent;while(l){if(l.$hidden){l.$hidden=false;}l[g.expand]="1";l=l.$parent;}}}}m=null;this.render();},moveStart:function(g){var h=this.options.params,i=this.nodeData(g);g.addClass("bt-moving");if(i){var j=i[h.leaf]=="0",m=i[h.expand]=="1",l=(j&&this.descendants(i))||[],r=l.length,n=i.$parent,q=i[h.id],o=this.indexes[q];this.moving.data=this.data.splice(o,1)[0];this.moving.desc=[];this.moving.orig={};if(r){this.moving.desc=this.data.splice(o,r);if(m){this.toggle(g,true,"collapse");var p=l.map(function(s){return"[data-id="+s[h.id]+"]";}).join(",");this.grid.find(p).remove();}}this.moving.orig.$index=o;if(n){var k=c(n.$child,q);this.moving.data.$parent=null;this.moving.orig.$parent=n;this.moving.orig.$posidx=k;n.$child.splice(k,1);if(!n.$child.length){n.$child=undefined;n[h.leaf]="1";}}this.reindex();}},moveStop:function(D,J,E){var l=this.options,L=l.params,v=D.prev(".bt-node"),w=D.next(".bt-node"),h=-1,p=true;D.removeClass("bt-moving");if(this.moving.data){if(w.length){h=this.indexes[w.attr("data-id")];}else{if(v.length){var K=v.attr("data-id"),s=this.indexes[K],F=this.data[s];if(F[L.leaf]=="0"&&F[L.expand]=="0"){var k=this.descendants(F);h=s+k.length+1;}else{h=s+1;}}}this.data.splice(h,0,this.moving.data);if(this.moving.desc.length){h++;var j=[h,0].concat(this.moving.desc);Array.prototype.splice.apply(this.data,j);}this.reindex();if(this.moving.orig.$parent){var x=this.moving.orig.$parent.$child||[];if(x.length){var P=this.data[this.indexes[x[x.length-1]]];if(P){P.$last=true;}}}var I=this.moving.data[L.id],q=this.indexes[I],C=this.data[q],r=+C[L.level],t=null;var H=E-l.buffSize;if(H<-l.dragSize){t=r-(Math.round(Math.abs(H)/l.stepSize));}else{if(H>l.dragSize){t=r+(Math.round(H/l.stepSize));}else{t=r;}}t=t<0?0:t;if(v.length){var B=v.attr("data-id"),n=this.indexes[B],u=this.data[n],o=+u[L.level],O,m;if(u[L.leaf]=="1"){if(t>o){console.log("A");C.$parent=u;C.$last=true;C[L.level]=o+1;u.$child=[I];if(u.$parent){u.$last=c(u.$parent.$child,B)==u.$parent.$child.length-1;}else{u.$last=!this.next(u);}u[L.leaf]="0";u[L.expand]="1";}else{if(t==o){if(u.$parent){console.log("B");O=c(u.$parent.$child,B);C.$parent=u.$parent;C.$last=O==u.$parent.$child.length-1;C[L.level]=t;u.$last=false;u.$parent.$child.splice(O+1,0,I);}else{console.log("C");C.$parent=null;C.$last=this.data[q+1]===false;C[L.level]=o;u.$last=false;}}else{console.log("D");p=this.bubbleMove(C,q,t,n);}}}else{if(u[L.expand]=="0"){if(t>o||t==o){if(u.$parent){console.log("E");O=c(u.$parent.$child,B);C.$parent=u.$parent;C.$last=O==u.$parent.$child.length-1;C[L.level]=o;u.$last=false;u.$parent.$child.splice(O+1,0,I);}else{console.log("F");C.$parent=null;C.$last=this.data[q+1]===false;C[L.level]=o;}}else{console.log("G");p=this.bubbleMove(C,q,t,n);}}else{if(t>o){console.log("H");C.$parent=u;C.$last=false;C[L.level]=o+1;u.$child.unshift(I);}else{console.log("I");p=this.bubbleMove(C,q,t,n);}}}}else{if(w.length){console.log("J");var g=w.attr("data-id"),z=this.indexes[g],M=this.data[z];C.$parent=M.$parent;C.$last=false;C[L.level]=M[L.level];}else{console.log("K");C.$parent=null;C.$last=true;C[L.level]=0;}}if(this.moving.desc){var A=this.moving.desc.length,y=+C[L.level]-r,G;for(G=0;G<A;G++){this.moving.desc[G][L.level]=+this.moving.desc[G][L.level]+y;}}this.moving.data=null;this.moving.desc=[];this.moving.orig=null;this.render();if(p){var N={parent:this.parent(C),prev:this.prev(C),next:this.next(C)};this.fireEvent("move",C,N);}}},bubbleMove:function(r,l,j,h){var z=this.options.params,w=r[z.id],p=this.data[h],t=[],u=j-1,k;while(p){k=+p[z.level];if(k==j){t.push(p);}if(k==u){break;}p=this.data[h--];}var y=false,m=r[z.leaf]=="0",x=[],s,o,q,v;if(m){if(r[z.expand]=="1"){x=this.descendants(r);s=x.length;o=this.indexes[x[s-1][z.id]];q=this.data[o+1];}else{q=this.data[l+1];}}else{q=this.data[l+1];}if(q){y=+q[z.level]>j;}if(!y){var n=t.length;if(n){for(v=0;v<n;v++){t[v].$last=false;}}if(p){r.$parent=p;p.$child=p.$child||[];p.$child.splice(n,0,w);r.$last=n===p.$child.length-1;r[z.level]=j;}else{r.$parent=null;r[z.level]=0;q=this.next(r);if(q){r.$last=false;}}}else{var g=this.moving.orig;if(g.$parent){r.$parent=g.$parent;if(g.$parent.$child===e){g.$parent.$child=[w];g.$parent[z.leaf]="0";}else{g.$parent.$child.splice(g.$posidx,0,w);}}x.unshift(r);this.data.splice(l,x.length);Array.prototype.splice.apply(this.data,[g.$index,0].concat(x));this.reindex();}t=null;return !y;},_moveData:function(h,g){this.data.splice(g,0,this.data.splice(h,1)[0]);this.reindex();},moveData:function(m,l,k){var j=this.data.length,h,g;if(m!=l&&m>=0&&m<=j&&l>=0&&l<=j){h=this.data[m];if(m<l){for(g=m;g<l;g++){this.data[g]=this.data[g+1];}}else{for(g=m;g>l;g--){this.data[g]=this.data[g-1];}}this.data[l]=h;k=k===e?true:k;k&&this.reindex();}},navigate:function(l){var j=l.keyCode||l.which;if(j==9||j==38||j==40){var i=this.grid.find(".bt-selected"),g,h;l.preventDefault();if(i.length){switch(j){case 9:var m=l.shiftKey?"prev":"next",k=i[m].call(i);k.length&&this.startEdit(k);break;case 38:h=i.prev(".bt-node");h.length&&this.startEdit(h);break;case 40:g=i.next(".bt-node");g.length&&this.startEdit(g);break;}}}},plugin:function(){return this;},tickStart:function(g){this.markers=this.markers||{};g=g===e?"_":g;this.markers[g]=new Date();},tickStop:function(h){this.markers=this.markers||{};h=h===e?"_":h;if(this.markers[h]!==e){var g=((new Date()-this.markers[h])/1000)+"ms";console.log(h+": "+g);}},fireEvent:function(){var h=f.makeArray(arguments),g=h.shift()+".bt";this.element.trigger(g,h);},destroy:function(g){this.edtext.off(".bt");this.element.off(".bt");this.element.sortable("destroy");f.removeData(this.element.get(0),"bigtree");this.data=null;this.indexes=null;this.orphans=null;this.selected=null;if(g!==e&&g===true){this.editor.remove();this.element.remove();}}};f.fn.bigtree=function(h){var g=f.makeArray(arguments),k=f.type(g[0])!=="string",j,i;j=this.each(function(){var l=f.data(this,"bigtree");if(!l){f.data(this,"bigtree",(l=new d(this,h)));}if(!k){var m=g.shift();if(f.isFunction(l[m])){i=l[m].apply(l,g);}else{throw Error(m+" is not function!");}}});return k?j:i;};}(jQuery));