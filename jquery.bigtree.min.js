!function(t,e){function i(t,e){for(var i=t.length,s=0;i>s;){if(t[s]===e)return s;s++}return-1}function s(t){return t=t||[],t[t.length-1]}function n(t,i,s){var n,r=t[0];if(i=i===e?0:i,s=s===e?t.val().length:s,r.setSelectionRange){if(r.setSelectionRange(i,s),/chrom(e|ium)/.test(navigator.userAgent.toLowerCase())){var a=jQuery.Event("keydown",{which:37});t.triggerHandler(a)}}else r.createTextRange&&(n=r.createTextRange(),n.collapse(!0),n.moveEnd("character",s),n.moveStart("character",i),n.select())}function r(){for(var e=t.makeArray(arguments),i=["["+e.shift()+"]"],s=0,n=e.length;n>s;s++)i.push(" ; "),i.push(e[s]);console.log.apply(console,i)}var a=function(e,i){this.element=t(e),this.init(i)};a.defaults={fields:{id:"id",text:"text",left:"left",right:"right",level:"level",leaf:"leaf",path:"path",expand:"expand"},itemSize:32,dragSize:16,stepSize:25,buffSize:20,delay:10,buffer:10,markup:'<div class="bt-node bt-hbox {{if _last}}bt-last{{/if}}" data-id="{{:id}}" data-level="{{:level}}" data-leaf="{{:leaf}}">{{for _elbows}}<div class="bt-node-elbow {{:type}}">{{:icon}}</div>{{/for}}<div class="bt-node-body bt-flex bt-hbox"><div class="bt-drag"></div><div class="bt-text bt-flex bt-hbox">{{:text}}</div><div class="bt-plugin"></div><div class="bt-trash"></div></div></div>',debug:!0},a.prototype={init:function(e){this.options=t.extend(!0,{},a.defaults,e||{}),this._data=[],this._indexes={},this._visible=[],this._message="",this._initComponent(),this._initEvents(),this._fireEvent("init")},_initComponent:function(){var e=this.options;e.fields;this.element.addClass("bigtree").attr("tabindex",1),this.editor=t('<div class="bt-editor"><input type="text"></div>'),this.edtext=this.editor.children("input"),this.grid=t('<div class="bt-grid">').appendTo(this.element),t.templates({btnode:{markup:e.markup}}),this.element.sortable({items:".bt-node",handle:".bt-drag",placeholder:"bt-node-sortable ui-sortable-placeholder"})},_initEvents:function(){var e=this.options,i=this.element.scrollTop(),s="",n=0;t(".task-search").on("click",t.proxy(function(){var t=prompt("action","append"),e=prompt(t),i=prompt("data");this[t].call(this,this._data[+e],this._data[+i])},this)),this.element.off("scroll.bt").on("scroll.bt",t.debounce(e.delay,t.proxy(function(){var t=this.element.scrollTop(),r=t>i?"down":"up";n=s!=r?0:n+Math.abs(t-i),(0===n||n>=e.buffer*e.itemSize)&&(this.render(),n=0),i=t,s=r},this))),this.element.off("click.bt.expander").on("click.bt.expander",".elbow-expander",t.proxy(function(e){e.stopPropagation();var i=t(e.currentTarget).closest(".bt-node"),s=this.get(i.attr("data-id"));s&&(this.isexpanded(s)?this.collapse(s):this.expand(s))},this)),this.element.off("keydown.bt").on("keydown.bt",t.proxy(this._navigate,this)),this.element.off("sortstart.bt").on("sortstart.bt",t.proxy(function(t,e){this._beforeDrag(e.item)},this)),this.element.off("sortstop.bt").on("sortstop.bt",t.proxy(function(t,e){this._afterDrag(e.item,e.position.left)},this)),this.element.off("click.bt.select").on("click.bt.select",t.proxy(function(){this.deselectAll()},this)),this.element.off("click.bt.startedit").on("click.bt.startedit",".bt-text",t.proxy(function(e){e.stopPropagation();var i=t(e.currentTarget).closest(".bt-node");this._startEdit(i)},this)),this.edtext.off("click.bt").on("click.bt",function(t){t.preventDefault(),t.stopPropagation()}),this.edtext.off("keypress.bt").on("keypress.bt",t.proxy(function(t){13==t.keyCode&&(t.preventDefault(),this._stopEdit(!1))},this))},hasScroll:function(){return this.element[0].scrollHeight>this.element.height()},load:function(t,i){var s,n=(this.options.fields,this._data.length);this._data.push.apply(this._data,t||[]),s=this._data.length,this._reindex(n,s),this._rebuild(n,s),i=i===e?!1:i,i&&this.render()},_reindex:function(t,i){var s,n=this.options.fields;for(t=t===e?0:t,i=i===e?this._data.length:i,s=t;i>s;s++)this._indexes[this._data[s][n.id]]=s},_rebuild:function(t,i){var n,r=this.options.fields,a=null;for(t=t===e?0:t,i=i===e?this._data.length:i,t>0&&this._data[t]&&(a=this._data[t]._root||null),n=t;i>n;n++){var o=this._data[n];o[r.id];if(0===+o[r.level])a&&(a._last=!1),o._root=null,o._parent=null,o._last=!0,o._hidden=!1,o._elbows=[],a=o;else{var l,h,d=o[r.path].split("/");d.pop(),d=d.pop(),l=this._data[this._indexes[d]],l._child=l._child||[],h=this._data[this._indexes[s(l._child)]],h&&(h._last=!1),o._root=a,o._parent=l,o._last=!0,o._hidden=0===+l[r.expand]||l._hidden,o._elbows=[],l._child.push(o[r.id])}}},render:function(){var e=this.options.buffer*this.options.itemSize,i=this.grid.scrollTop()-this.grid.position().top-e,s=i+this.element.height()+2*e,n=t.grep(this._data,function(t){return!t._hidden});i=0>i?0:i;var r=Math.floor(i/this.options.itemSize),a=Math.ceil(s/this.options.itemSize),o=this.options.itemSize*r,l=this.options.itemSize*n.slice(a).length+3*this.options.itemSize;this.grid.css({paddingTop:o,paddingBottom:l}),this._renderRange(n,r,a)},scroll:function(e){var s=this.options,n=t.grep(this._data,function(t){return!t._hidden}),r=i(n,e)*s.itemSize,a=this.element;a.animate({scrollTop:r},r)},_renderRange:function(e,i,s){var n=e.slice(i,s),r=this.options.fields,a=this.movedNode();this._fireEvent("beforenodesrender"),this.editor.detach(),this.removableNodes().remove(),a.length&&(n=t.grep(n,function(t){return t[r.id]!=a.attr("data-id")})),this._visible=n;for(var o=0,l=n.length;l>o;o++){for(var h,d,f,e=n[o],c=e._parent,p=+e[r.level],u=0===+e[r.leaf],_=1===+e[r.expand],v=[],g=[];c;)v[c[r.level]]=c._last?0:1,c=c._parent;for(f=0;p>=f;f++)f===p?(h="elbow-end",d=u?'<span class="elbow-expander '+(_?"elbow-minus":"elbow-plus")+'"></span>':""):(h=1===v[f]?"elbow-line":"",d=""),g.push({type:h,icon:d});e._elbows=g}this.grid.append(t.templates.btnode(n)),this.element.focus(),a.length?this.element.sortable("refresh"):this._decorate();var b=this.visible(),x=this.visibleNodes();this._fireEvent("nodesrender",x,b)},_decorate:function(){if(this._selected){var t=this.grid.find(".bt-node[data-id="+this._selected+"]");t.length&&this.select(t)}},visible:function(){return this._visible},create:function(e){if(!e)throw new Error("create(): data spec doesn't meet requirement");var i,s={};for(i in this.options.fields)s[i]=e[i]||"";return{node:t.templates.btnode(s),data:s}},remove:function(t){t=t||{}},update:function(t,e){t=t||{},e=e||{}},append:function(t,e){if(this._isvalid(e,"append",t)){var i=this.descendants(e),s=this.nodeof(t);this._detach(e,i),this._attach(e,i,"append",t),s.length&&this.render()}else this._debug()},before:function(t,e){if(this._isvalid(e,"before",t)){var i=this.descendants(e),s=this.nodeof(t);this._detach(e,i),this._attach(e,i,"before",t),s.length&&this.render()}else this._debug()},after:function(t,e){if(this._isvalid(e,"after",t)){var i=this.descendants(e),s=this.nodeof(t);this._detach(e,i),this._attach(e,i,"after",t),s.length&&this.render()}else this._debug()},_isvalid:function(t,e,i){var s=this.options.fields;if(this.isphantom(i))return this._error(e+"(): offset data doesn't exists!"),!1;if(this.isparent(t))return this._error(e+"(): data doesn't exists!"),!1;if(i[s.id]==t[s.id])return this._error(e+"(): can't move to itself!"),!1;if(this.isdescendant(t,i))return this._error(e+"(): can't move to descendant!"),!1;switch(e){case"before":if(this.index(i)-this.descendants(t).length-1==this.index(t)&&t[s.level]==i[s.level])return this._error("before(): nothing to move!"),!1;break;case"after":if(this.index(i)+this.descendants(i).length+1==this.index(t)&&t[s.level]==i[s.level])return this._error("after(): nothing to move!"),!1;break;case"append":var n=i._child||[];if(n[n.length-1]==t[s.id])return this._error("append(): nothing to move!"),!1;if(!this.isexpanded(i))return this._error("append(): can't append to collapsed data!"),!1}return!0},_beforeDrag:function(t){var e=this.options.fields,i=this.dataof(t);if(this.deselectAll(),this.select(t),t.addClass("bt-moving"),i){var s,n=(1===+i[e.expand],this.descendants(i)),r=n.length;r&&(this.toggle(t,!0,"collapse"),s=n.map(function(t){return".bt-node[data-id="+t[e.id]+"]"}).join(","),this.grid.children(s).remove())}},_afterDrag:function(t,e){var i=this.options,s=(this._indexes,i.fields),n=this._data,a=this.dataof(t),o=t.prev(".bt-node"),l=t.next(".bt-node"),h=function(t,e,i){var r,a=[],o=i-1,l=n[e];for(o=0>o?0:o;l&&(r=+l[s.level],r===i&&a.push(l),r!==o);)l=n[--e];return a.length?["after",a[a.length-1],t]:["append",l,t]};t.removeClass("bt-moving");var d=+a[s.level],f=0,c=5,p=[];if(e-=i.buffSize,f=e+c<-i.dragSize?d-Math.round(Math.abs(e)/i.stepSize):e>i.dragSize?d+Math.round(e/i.stepSize):d,f=0>f?0:f,o.length){var u=this.dataof(o),_=this.level(u),v=this.index(u),g=u._child||[];p=f>_?g.length?this.isexpanded(u)?["before",this.get(g[0]),a]:["after",u,a]:["append",u,a]:f===_?["after",u,a]:h(a,v,f)}else if(l.length){var b=this.dataof(l);p=["before",b,a]}else r("move","nothing to move");if(p.length){var x=p.shift();this[x].apply(this,p),this.isvisible(a)||this.scroll(a)}},_detach:function(t,e){var s=this.options.fields,n=this.index(t),r=e.length;if(n>-1){t._origin=null;var a=t._parent||null,o=new RegExp(".*(?="+(a?"/":"")+t[s.id]+"/?)"),l=new RegExp("^/");if(level=+t[s.level],a){a._child=a._child||[];var h=i(a._child,t[s.id]);h>-1&&(a._child.splice(h,1),a._child.length||(a[s.leaf]="1")),t._origin=a}else{var d=this.prev(t);d&&(t._origin=d)}if(this._data.splice(n,1),delete this._indexes[t[s.id]],t._parent=null,t._root=null,t[s.level]=0,t[s.path]=t[s.path].replace(o,"").replace(l,""),r){this._data.splice(n,r);for(var f=0;r>f;f++)e[f]._root=null,e[f][s.path]=e[f][s.path].replace(o,"").replace(l,""),e[f][s.level]=+e[f][s.level]-level,delete this._indexes[e[f][s.id]]}o=null,l=null,this._reindex(n)}},_attach:function(t,e,i,s){var n,r=this.options.fields,a=e.length,o=-1,l="",h=0,d=0,f=null,c=null,p=0;switch(i){case"after":o=this.index(s),d=+s[r.level],f=s._parent,c=s._root,p=+s[r.left]+this.size(s),f?(l=f[r.path]+"/",h=this.index(f)):h=o,o+=this.descendants(s).length+1;break;case"before":o=this.index(s),d=+s[r.level],f=s._parent,c=s._root,p=+s[r.left],f&&(l=f[r.path]+"/",h=this.index(f));break;case"append":l=s[r.path]+"/",o=this.index(s),d=+s[r.level]+1,c=s._root,p=+s[r.right],h=o,o+=this.descendants(s).length+1,"1"==s[r.leaf]&&(s[r.leaf]="0")}if(o>-1){if(this._data.splice(o,0,t),t._root=c,t[r.level]=d,t[r.path]=l+t[r.path],a)for(Array.prototype.splice.apply(this._data,[o+1,0].concat(e)),n=0;a>n;n++)e[n][r.level]=+e[n][r.level]+d,e[n][r.path]=l+e[n][r.path];this._reindex(o);var u,_;(u=t._origin)&&(_=this.index(u),h>_&&(h=_),delete t._origin);var v,g,b,x=p,m=+t[r.left],k=+t[r.right],y=this._data.length;for(n=0;y>n;n++)v=this._data[n],g=+v[r.left],b=+v[r.right],(x>k||m>x)&&(x>k?(g+=g>k&&x>g?m-k-1:g>=m&&k>g?x-k-1:0,b+=b>k&&x>b?m-k-1:b>m&&k>=b?x-k-1:0):(g+=g>=x&&m>g?k-m+1:g>=m&&k>g?x-m:0,b+=b>=x&&m>b?k-m+1:b>m&&k>=b?x-m:0),v[r.left]=g,v[r.right]=b),n>=h&&v._parent&&(v._parent._child=[]);this._rebuild(h)}},get:function(t){var e=this._indexes[t];return this._data[e]||null},data:function(t){return t!==e?this._data[t]:this._data},index:function(t){if(t){var i=this._indexes[t[this.options.fields.id]];return i===e?-1:i}return-1},size:function(t){return this.right(t)-this.left(t)+1},level:function(t){return+t[this.options.fields.level]},left:function(t){return+t[this.options.fields.left]},right:function(t){return+t[this.options.fields.right]},isphantom:function(t){return-1===this.index(t)},isleaf:function(t){return this.right(t)-this.left(t)===1},isparent:function(t){return!this.isleaf(t)},isancestor:function(t,e){return this.left(t)>this.left(e)&&this.right(t)<this.right(e)},isdescendant:function(t,e){return this.left(e)>this.left(t)&&this.right(e)<this.right(t)},isexpanded:function(t){return 1===+t[this.options.fields.expand]},iscollapsed:function(t){return!this.isexpanded(t)},isvisible:function(t){var e=this.visible();return i(e,t)>-1},first:function(){return this._data[0]},last:function(){return this._data[this._data.length-1]},parent:function(t){return t._parent},prev:function(t){var e,s=this.options.fields,n=t._parent,r=null;if(n){var a=n._child||[];e=this._indexes[a[i(a,t[s.id])-1]],r=this.data(e)}else{var o,l,h;for(e=this.index(t),h=this.level(t),o=this._data[--e];o&&(l=+o[s.level])>=h;){if(l===h){r=o;break}o=this._data[--e]}}return r||null},next:function(t){var e,s=this.options.fields,n=t._parent,r=null;if(n){var a=n._child||[];e=this._indexes[a[i(a,t[s.id])+1]],r=this.data(e)}else{var o,l,h;for(e=this.index(t),l=this.level(t),o=this._data[++e];o&&(h=+o[s.level])>=l;){if(h===l){r=o;break}o=this._data[++e]}}return r},descendants:function(t){for(var e=this.options.fields,i=this._indexes[t[e.id]],s=this._data[++i],n=[],r=+t[e.right];s&&!(+s[e.right]>=r);)n.push(s),s=this._data[++i];return n},children:function(t){for(var e=t._child||[],i=e.length,s=[],n=0;i>n;n++){var r=this._indexes[e[n]],a=this._data[r];a&&s.push(a)}return s},createNode:function(e){return t(t.templates.btnode(e))},nodeof:function(t){return this.grid.children(".bt-node[data-id="+t[this.options.fields.id]+"]")},movedNode:function(){return this.grid.children(".ui-sortable-helper")},visibleNodes:function(){return this.grid.children(".bt-node:not(.ui-sortable-placeholder)")},removableNodes:function(){return this.grid.children(".bt-node:not(.ui-sortable-helper,.ui-sortable-placeholder)")},selectedNode:function(){var e=t({});return this._selected&&(e=this.grid.children(".bt-node[data-id="+this._selected+"]")),e.length?e:null},dataof:function(t){var e=t.attr("data-id");return this._data[this._indexes[e]]},cascade:function(){},expand:function(t){var i=this.options.fields,s=function(t){for(var n=this.children(t),r=n.length,a=0;r>a;a++)n[a]._hidden=!1,n[a]._child!==e&&"1"==n[a][i.expand]&&s.call(this,n[a])};t[i.expand]="1",s.call(this,t),this._fireEvent("expand",t),this.render()},collapse:function(t){var i=this.options.fields,s=function(t){for(var n=this.children(t),r=n.length,a=0;r>a;a++)n[a]._hidden=!0,n[a]._child!==e&&"1"==n[a][i.expand]&&s.call(this,n[a])};t[i.expand]="0",s.call(this,t),this._fireEvent("collapse",t),this.render()},expandAll:function(){},collapseAll:function(){},toggle:function(t,i,s){var n=t.find(".elbow-expander");if(i=i===e?!0:i,n.length&&i){var r=n.hasClass("elbow-plus")?"elbow-minus":"elbow-plus";s!==e&&(r="expand"==s?"elbow-minus":"elbow-plus"),n.removeClass("elbow-plus elbow-minus").addClass(r)}},select:function(t){this._selected=t.attr("data-id"),t.addClass("bt-selected")},deselect:function(t){this._selected=null,t.removeClass("bt-selected")},deselectAll:function(){this._selected=null,this.grid.children(".bt-selected").removeClass("bt-selected")},selection:function(){var t=this.grid.children(".bt-selected");return t.length?this._data[this._indexes[this._selected]]:null},_startEdit:function(e){var i=this._data[this._indexes[e.attr("data-id")]],s=this.options.fields,r=e.find(".bt-text"),a=i[s.text];i._orig&&i._orig.text&&(a=i._orig.text),this._stopEdit(!0),this.select(e),this.editor.appendTo(r),this.edtext.val(a).focus();var o=t.debounce(1,function(){n(this.edtext,a.length)});o.call(this)},_stopEdit:function(t){var i=this.options.fields,s=this.editor.closest(".bt-node");if(s.length){var n=this._data[this._indexes[s.attr("data-id")]],r=this.edtext.val(),a=n[i.text],o=r;n._orig&&n._orig.text&&(a=n._orig.text,o=n._orig.disp),n[i.text]=o,t=t===e?!0:t,t&&(this.deselect(s),this.editor.detach(),s.find(".bt-text").html(o)),r!=a&&this._fireEvent("edit",n,r)}else this._selected=null,this.grid.find(".bt-selected").removeClass("bt-selected")},query:function(t){var e,i,s,n,r=this.options.fields,a=new RegExp("("+t+")","igm"),o=this._data.length;for(n=0;o>n;n++)if(i=this._data[n],i._orig&&(i._hidden=i._orig.hidden,i[r.expand]=i._orig.expand,i[r.text]=i._orig.text,delete i._orig),t){e=i[r.text],i._orig={hidden:i._hidden,expand:i[r.expand],text:e};var l=a.exec(e);if(i._hidden=!0,l){s=i[r.text].replace(l[1],'<span class="bt-hightlight">'+l[1]+"</span>"),i._hidden=!1,i._orig.disp=s,i[r.text]=s;for(var h=i._parent;h;)h._hidden&&(h._hidden=!1),h[r.expand]="1",h=h._parent}}a=null,this.render()},swap:function(t,i,s){var n,r,a=this._data.length;if(t!=i&&t>=0&&a>=t&&i>=0&&a>=i){if(n=this._data[t],i>t)for(r=t;i>r;r++)this._data[r]=this._data[r+1];else for(r=t;r>i;r--)this._data[r]=this._data[r-1];this._data[i]=n,s=s===e?!0:s,s&&this._reindex()}},_navigate:function(t){var e=t.keyCode||t.which;if(9==e||38==e||40==e){var i,s,n=this.grid.find(".bt-selected");if(t.preventDefault(),n.length)switch(e){case 9:var r=t.shiftKey?"prev":"next",a=n[r].call(n);a.length&&this._startEdit(a);break;case 38:s=n.prev(".bt-node"),s.length&&this._startEdit(s);break;case 40:i=n.next(".bt-node"),i.length&&this._startEdit(i)}}},maps:function(){var e=t.makeArray(arguments),i=e.length,s=this._data.map(function(t){for(var s=[],n=0;i>n;n++)s.push(t[e[n]]);return s});console.log(s)},plugin:function(){return this},tickStart:function(t){this.markers=this.markers||{},t=t===e?"_":t,this.markers[t]=new Date},tickStop:function(t){if(this.markers=this.markers||{},t=t===e?"_":t,this.markers[t]!==e){var i=(new Date-this.markers[t])/1e3+"ms";console.log(t+": "+i)}},_fireEvent:function(){var e=t.makeArray(arguments),i=e.shift()+".bt";this.element.trigger(i,e)},_error:function(t){this._message=t},_debug:function(t){this.options.debug&&(t=t===e?this._message:t,console.log(t))},destroy:function(i){this.edtext.off(".bt"),this.element.off(".bt"),this.element.sortable("destroy"),t.removeData(this.element[0],"bigtree"),this._data=null,this._indexes=null,this._selected=null,i!==e&&i===!0&&(this.editor.remove(),this.element.remove())}},t.fn.bigtree=function(e){var i,s,n=t.makeArray(arguments),r="string"!==t.type(n[0]);return i=this.each(function(){var i=t.data(this,"bigtree");if(i||t.data(this,"bigtree",i=new a(this,e)),!r){var o=n.shift();if(!t.isFunction(i[o]))throw Error(o+" is not function!");s=i[o].apply(i,n)}}),r?i:s}}(jQuery);
//# sourceMappingURL=bigtree.min.js.map
